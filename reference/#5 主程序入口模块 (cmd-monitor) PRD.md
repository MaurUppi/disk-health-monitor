# 磁盘健康监控工具 - 主程序入口模块 (cmd/monitor) 产品需求文档

## 1. 概述

主程序入口模块是磁盘健康监控工具的命令行界面，负责集成所有底层组件并提供用户交互体验。该模块将组织工作流程，处理命令行参数，协调各子系统，并以用户指定格式输出结果。

## 2. 背景与目标

### 2.1 背景

磁盘健康监控工具已完成了多个核心模块的开发，包括：
- 系统交互层（command、logger）
- 数据模型层（model）
- 数据收集层（collector）
- 数据存储层（storage）
- 输出格式化层（output）

现在需要一个统一的入口点将这些组件整合起来，提供给最终用户使用。

### 2.2 目标

- 创建一个直观、功能完整的命令行界面
- 提供灵活的配置选项，满足不同用户需求
- 确保各组件间的无缝集成和协作
- 提供友好的错误处理和用户反馈
- 为未来功能扩展提供扩展点

## 3. 用户场景

### 3.1 系统管理员定期检查

系统管理员希望定期（如每周）检查服务器磁盘健康状态，并生成报告归档。

```bash
# 生成默认文本报告
disk-health-monitor -o weekly_report.txt

# 只查看有问题的磁盘
disk-health-monitor --only-warnings
```
``

### 3.4 自动化脚本调用

定时任务或脚本需要调用该工具并检查结果。

```bash
# 静默模式执行，只在发现问题时返回非零退出码
disk-health-monitor --quiet --exit-on-warning
```

## 4. 功能需求

### 4.1 命令行参数处理

1. **基本信息参数**
   - `-h, --help`：显示帮助信息
   - `-v, --version`：显示版本信息
   - `-d, --debug`：启用调试模式
   - `--verbose`：显示详细输出

2. **输出控制参数**
   - `-o, --output <file>`：指定输出文件路径
   - `-f, --format <format>`：指定输出格式（text、PDF）
   - `--quiet`：静默模式，减少屏幕输出

3. **数据筛选参数**
   - `--no-group`：不按类型分组显示
   - `--no-controller`：不显示控制器信息
   - `--controller-only`：只显示控制器信息
   - `--only-warnings`：只显示有警告或错误的磁盘

4. **运行行为参数**
   - `--data-file <file>`：指定历史数据文件
   - `--log-file <file>`：指定日志文件
   - `--timeout <seconds>`：设置命令执行超时时间
   - `--exit-on-warning`：发现警告时以非零状态退出

### 4.2 应用程序核心流程

1. **初始化阶段**
   - 解析命令行参数
   - 加载和验证配置
   - 设置日志系统
   - 初始化组件

2. **数据收集阶段**
   - 收集控制器信息
   - 收集磁盘信息
   - 加载历史数据
   - 计算数据增量

3. **输出阶段**
   - 初始化选定格式的格式化器
   - 处理并格式化收集的数据
   - 生成输出（屏幕和/或文件）

4. **清理阶段**
   - 保存当前数据作为历史记录
   - 关闭资源
   - 设置适当的退出码

### 4.3 错误处理与用户反馈

1. **多级错误处理**
   - 命令行参数错误处理
   - 组件初始化错误处理
   - 数据收集错误处理
   - 输出生成错误处理

2. **用户友好的反馈**
   - 清晰的错误消息
   - 进度指示（可选）
   - 执行摘要
   - 合理的退出码

### 4.4 扩展点

1. **插件支持**
   - 预留自定义收集器插件接口
   - 预留自定义输出格式插件接口

2. **配置文件支持**
   - 支持从文件加载配置参数
   - 用户级/系统级配置文件支持

## 5. 非功能需求

### 5.1 性能要求

1. **启动时间**
   - 应用启动到开始数据收集的时间应小于1秒

2. **资源使用**
   - 内存使用峰值不超过200MB（针对普通规模的系统）
   - CPU使用率峰值不超过一个核心的50%

3. **执行时间**
   - 对于标准配置的服务器（10-20个磁盘），完整执行时间应小于30秒

### 5.2 可靠性

1. **稳定性**
   - 任何非致命错误不应导致整个应用崩溃
   - 对于部分失败的数据收集，应继续处理其余数据

2. **错误处理**
   - 所有可预见的错误都应有适当的恢复策略
   - 详细记录错误信息以便诊断

### 5.3 可用性

1. **用户界面**
   - 命令行参数应遵循常见约定和最佳实践
   - 帮助信息应清晰、完整，包含示例
   - 提供一致的进度和状态反馈

2. **辅助功能**
   - 支持输出重定向和管道
   - 提供适合脚本使用的退出码

### 5.4 可维护性

1. **代码组织**
   - 清晰的责任分离
   - 模块化设计
   - 全面的注释和文档

2. **日志和监控**
   - 详细的操作日志
   - 关键点性能指标
   - 错误和异常跟踪

### 5.5 可扩展性

1. **功能扩展**
   - 设计支持添加新命令和参数
   - 支持未来添加新的输出格式
   - 提供扩展点以添加新功能

## 6. 技术架构

### 6.1 组件关系图

```
                  ┌─────────────────┐
                  │  cmd/monitor    │
                  │                 │
                  │  main.go        │◄────┐
                  │  command.go     │     │
                  │  application.go │     │
                  └─────┬───────────┘     │
                        │                 │
             ┌──────────┴────────┐        │
             │                   │        │
┌────────────▼─────┐   ┌─────────▼──────┐ │
│                  │   │                │ │
│ model            │   │ system         │ │
│ ├── config.go    │◄──┤ ├── command.go │ │
│ ├── disk-model.go│   │ └── logger.go  │ │
│ └── controller.go│   │                │ │
│                  │   └────────────────┘ │
└──────┬───────────┘                      │
       │                                  │
┌──────▼────────────────────────────┐     │
│                                   │     │
│ collector                         │     │
│ ├── disk.go                       │     │
│ ├── controller_collector.go       │     │
│ ├── smart.go                      │     │
│ └── pool.go                       │     │
│                                   │     │
└────────────┬──────────────────────┘     │
             │                            │
┌────────────▼──────────────────────┐     │
│                                   │     │
│ storage                           │     │
│ └── history.go                    │     │
│                                   │     │
└────────────┬──────────────────────┘     │
             │                            │
┌────────────▼──────────────────────┐     │
│                                   │     │
│ output                            │     │
│ ├── formatter.go                  │─────┘
│ └── text.go                       │
│                                   │
└───────────────────────────────────┘
```

### 6.2 数据流

1. **输入流**
   - 命令行参数 → 配置对象
   - 配置对象 → 各组件初始化

2. **处理流**
   - 系统命令 → 控制器收集器 → 控制器数据
   - 系统命令 → 磁盘收集器 → 磁盘数据
   - 历史数据文件 → 存储组件 → 历史数据
   - 历史数据 + 当前数据 → 增量计算

3. **输出流**
   - 控制器数据 + 磁盘数据 → 格式化器 → 格式化输出
   - 当前数据 → 存储组件 → 历史数据文件

## 7. 接口设计

### 7.1 命令行接口

```
用法: disk-health-monitor [选项...]

选项:
  基本选项:
    -h, --help             显示此帮助信息并退出
    -v, --version          显示版本信息并退出
    -d, --debug            启用调试模式
    --verbose              显示详细输出信息

  输出选项:
    -o, --output FILE      输出到指定文件
    -f, --format FORMAT    指定输出格式 (text, json)
    --quiet                静默模式，减少屏幕输出

  显示选项:
    --no-group             不按类型分组显示
    --no-controller        不显示控制器信息
    --controller-only      只显示控制器信息
    --only-warnings        只显示有警告或错误的磁盘
    --compact              使用紧凑输出模式

  高级选项:
    --data-file FILE       指定历史数据文件
    --log-file FILE        指定日志文件
    --timeout SECONDS      设置命令执行超时时间
    --exit-on-warning      发现警告时以非零状态退出

例子:
  disk-health-monitor                    # 显示所有磁盘和控制器信息
  disk-health-monitor -o report.txt      # 将输出保存到文件
  disk-health-monitor --only-warnings    # 只显示有问题的磁盘
  disk-health-monitor --controller-only  # 只显示控制器信息
```

### 7.2 应用程序接口

```go
// Application 表示应用程序的主要结构
type Application struct {
    Config         *model.Config       // 应用配置
    Logger         system.Logger       // 日志系统
    CommandRunner  system.CommandRunner // 命令执行器
    DiskCollector  *collector.DiskCollector     // 磁盘收集器
    CtrlCollector  *collector.ControllerCollector // 控制器收集器
    HistoryStorage *storage.HistoryStorage     // 历史数据存储
}

// Initialize 初始化应用程序
func (app *Application) Initialize() error

// CollectData 收集磁盘和控制器数据
func (app *Application) CollectData() (*model.DiskData, *model.ControllerData, error)

// GenerateOutput 生成指定格式的输出
func (app *Application) GenerateOutput(diskData *model.DiskData, ctrlData *model.ControllerData) error

// Run 运行完整的应用程序流程
func (app *Application) Run() int
```

### 7.3 退出码

```
0: 成功 - 无错误或警告
1: 命令行参数错误
2: 初始化错误（配置无效、日志设置失败等）
3: 数据收集错误（所有收集操作失败）
4: 输出生成错误
5: 警告存在（--exit-on-warning启用时）
```

## 8. 实现计划

### 8.1 实现阶段

1. **第一阶段：基础结构（2天）**
   - 创建项目目录结构
   - 实现命令行参数解析
   - 设计应用核心结构

2. **第二阶段：组件集成（3天）**
   - 集成配置模块
   - 集成系统交互模块
   - 集成数据收集模块
   - 集成存储模块
   - 集成输出格式化模块

3. **第三阶段：核心功能（2天）**
   - 实现数据收集流程
   - 实现输出生成流程
   - 实现错误处理和用户反馈

4. **第四阶段：优化与测试（3天）**
   - 完善帮助和文档
   - 优化性能和资源使用
   - 进行单元测试和集成测试
   - 处理边缘情况和错误条件

### 8.2 测试策略

1. **单元测试**
   - 命令行参数解析测试
   - 应用程序核心流程测试
   - 组件集成测试

2. **集成测试**
   - 端到端功能测试
   - 不同参数组合测试
   - 错误情况和恢复测试

3. **性能测试**
   - 大规模系统测试（多磁盘环境）
   - 资源使用监控
   - 启动时间和执行时间测试

## 9. 风险与缓解策略

| 风险 | 影响 | 可能性 | 缓解策略 |
|------|------|-------|---------|
| 外部命令执行失败 | 高 | 中 | 实现多级降级策略，提供备用数据收集方法 |
| 大型系统性能问题 | 中 | 低 | 实现并发数据收集，限制并发度，添加进度指示 |
| 命令行参数冲突 | 低 | 低 | 全面的参数验证，明确优先级规则 |
| 历史数据兼容性 | 中 | 低 | 实现版本检测和数据迁移机制 |
| 输出格式错误 | 中 | 低 | 全面测试各种输出场景，优雅降级到简单格式 |

## 10. 附录

### 10.1 示例用法场景

#### 基本使用
```bash
# 默认模式 - 收集并显示所有信息
disk-health-monitor

# 将结果保存到文件
disk-health-monitor -o health_report.txt

# 使用JSON格式
disk-health-monitor -f json -o health_data.json
```

#### 筛选信息
```bash
# 只显示控制器信息
disk-health-monitor --controller-only

# 只显示有警告或错误的磁盘
disk-health-monitor --only-warnings

# 不分组显示磁盘
disk-health-monitor --no-group
```

#### 高级用法
```bash
# 静默运行，只在有警告时退出非零状态
disk-health-monitor --quiet --exit-on-warning

# 调试模式，收集更多日志信息
disk-health-monitor -d --log-file debug.log

# 指定数据文件位置
disk-health-monitor --data-file /path/to/history_data.json
```

### 10.2 依赖关系

1. **内部依赖**
   - model包：提供数据模型和配置定义
   - system包：提供系统交互功能
   - collector包：提供数据收集功能
   - storage包：提供历史数据管理
   - output包：提供输出格式化

2. **外部依赖**
   - 系统工具：smartctl、lspci、zpool等
   - Go标准库：flag、os、fmt等

### 10.3 开发环境要求

1. **开发工具**
   - Go 1.18或更高版本
   - 支持Go模块的IDE

2. **测试环境**
   - 至少包含3种不同类型磁盘的系统
   - 不同操作系统环境（Linux、FreeBSD）