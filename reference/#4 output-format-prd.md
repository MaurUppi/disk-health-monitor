# 磁盘健康监控工具 - 输出格式模块产品需求文档 (PRD)

## 1. 背景与概述

输出格式模块是磁盘健康监控工具的关键组件，负责将收集到的磁盘和控制器信息转换为结构化、可读性强的格式，便于用户查看和分析。通过提供多种输出格式选项，该模块增强了工具的灵活性和适用性。

当前设计支持两种主要的输出格式：专业PDF报告和命令行/文本输出。这两种格式将满足不同场景下的需求，包括系统管理员的日常监控和正式报告生成。

## 2. 目标

- 设计并实现清晰、一致的数据展示逻辑
- 支持PDF和文本两种主要输出格式
- 提供结构化的数据分组和排序功能
- 通过视觉元素（如颜色和符号）突出显示重要信息
- 确保输出内容在不同环境中保持良好的可读性
- 支持历史数据比较和增量显示

## 3. 功能需求

### 3.1 通用功能

1. **一致的数据展示**
   - 按磁盘类型（SAS SSD、SAS HDD、NVMe SSD、虚拟设备）对数据进行分组
   - 为每个磁盘类型显示相关的健康指标
   - 为控制器信息提供单独的分组展示
   - 支持自定义分组和不分组显示

2. **数据排序**
   - 支持按磁盘名称、型号、容量等字段排序
   - 默认按磁盘名称字母顺序排序

3. **状态突出显示**
   - 使用颜色或符号标记不同的健康状态（正常、警告、错误）
   - 为温度等关键指标提供视觉指示

4. **摘要信息**
   - 显示系统整体状态的摘要信息（总磁盘数、警告数、错误数等）
   - 标记最近更新时间和生成信息

5. **历史数据比较**
   - 在有历史数据时，显示读写数据的增量变化
   - 提供时间段比较的功能

### 3.2 PDF输出格式

1. **报告结构**
   - 封面页：包含系统名称、报告生成时间和摘要信息
   - 目录：主要章节链接和页码
   - 概述：系统硬件配置和健康状态摘要
   - 控制器信息：所有存储控制器详情
   - 磁盘信息：按类型分组的磁盘详情
   - 历史数据：读写增量和趋势分析

2. **视觉设计**
   - 专业的表格设计，带有合适的边框和颜色
   - 颜色编码状态指示器（绿色=正常，黄色=警告，红色=错误）
   - 温度计式视觉指示器用于温度显示
   - 一致的字体和样式

3. **功能特性**
   - 支持不同纸张大小（A4、Letter）
   - 自动分页和页眉页脚
   - 书签导航功能
   - 表格自动断页和头部重复

4. **数据完整性**
   - 确保所有重要信息都包含在报告中
   - 为特殊字段提供脚注和解释

### 3.3 文本输出格式

1. **表格结构**
   - 使用ASCII或Unicode字符构建表格边框
   - 支持不同的边框样式（经典、简洁、无边框）
   - 保持列对齐和数据格式一致

2. **终端增强**
   - 支持ANSI颜色代码（仅在终端输出时）
   - 使用特殊符号标记状态（√, !, ×）
   - 自适应终端宽度，避免换行混乱

3. **输出模式**
   - 标准模式：完整信息，适合大型终端或文件输出
   - 紧凑模式：精简信息，适合有限空间显示
   - 摘要模式：仅显示关键指标和异常

4. **布局优化**
   - 字段宽度自动调整，确保关键信息可见
   - 长文本字段的智能截断和提示
   - 一致的分组间距和分隔符

## 4. 接口设计

### 4.1 OutputFormatter接口

```go
// OutputFormatter 定义输出格式化接口
type OutputFormatter interface {
    // FormatDiskInfo 格式化磁盘信息
    FormatDiskInfo(diskData *model.DiskData) error
    
    // FormatControllerInfo 格式化控制器信息
    FormatControllerInfo(controllerData *model.ControllerData) error
    
    // SaveToFile 保存到文件
    SaveToFile(filename string) error
    
    // SetOption 设置格式化选项
    SetOption(name string, value interface{}) error
    
    // GetSupportedOptions 获取支持的选项列表
    GetSupportedOptions() map[string]string
}
```

### 4.2 PDF格式化器

```go
// PDFFormatter 实现PDF输出
type PDFFormatter struct {
    options map[string]interface{}  // 配置选项
    diskData *model.DiskData        // 磁盘数据
    controllerData *model.ControllerData  // 控制器数据
    pdf *pdf.PdfWriter              // PDF生成器
}

// 支持的选项
var PDFOptions = map[string]string{
    "paper_size": "设置纸张大小，可选值: a4, letter",
    "orientation": "设置纸张方向，可选值: portrait, landscape",
    "include_cover": "是否包含封面，可选值: true, false",
    "color_output": "是否使用彩色输出，可选值: true, false",
    "font_size": "设置字体大小，范围: 8-14",
}
```

### 4.3 文本格式化器

```go
// TextFormatter 实现文本输出
type TextFormatter struct {
    options map[string]interface{}  // 配置选项
    diskData *model.DiskData        // 磁盘数据
    controllerData *model.ControllerData  // 控制器数据
    buffer *strings.Builder         // 文本缓冲
}

// 支持的选项
var TextOptions = map[string]string{
    "use_color": "是否使用ANSI颜色代码，可选值: true, false",
    "border_style": "表格边框样式，可选值: classic, simple, none",
    "max_width": "最大宽度，0表示不限制",
    "compact_mode": "是否使用紧凑模式，可选值: true, false",
    "align_columns": "是否对齐列，可选值: true, false",
}
```

### 4.4 格式化器工厂

```go
// NewFormatter 创建指定类型的格式化器
func NewFormatter(format string, options map[string]interface{}) (OutputFormatter, error) {
    switch strings.ToLower(format) {
    case "pdf":
        return NewPDFFormatter(options), nil
    case "text":
        return NewTextFormatter(options), nil
    default:
        return nil, fmt.Errorf("不支持的输出格式: %s", format)
    }
}
```

## 5. 技术实现

### 5.1 PDF输出实现

1. **依赖库**
   - 主要使用 `github.com/unidoc/unipdf/v3` 实现PDF生成
   - 处理表格、样式和页面布局

2. **页面结构**
   - 使用页眉页脚模板确保一致性
   - 实现自定义表格结构，支持复杂布局
   - 使用字体和颜色样式提升视觉体验

3. **表格设计**
   - 使用unipdf的表格功能实现数据展示
   - 支持表头固定和表格跨页
   - 应用条件格式化（如基于状态的颜色）

4. **内容渲染流程**
   1. 初始化PDF文档和页面设置
   2. 生成封面和目录（如启用）
   3. 生成摘要信息区块
   4. 按顺序渲染控制器和磁盘表格
   5. 处理页码和页眉页脚
   6. 完成PDF文档并保存

5. **特殊效果**
   - 为温度等字段实现自定义视觉指示器
   - 使用图标或符号增强状态显示
   - 处理中文和特殊字符的正确显示

### 5.2 文本输出实现

1. **依赖库**
   - 使用 `github.com/olekukonko/tablewriter` 实现ASCII表格
   - 使用 `github.com/fatih/color` 处理终端颜色（可选）

2. **表格生成**
   - 设计灵活的表格构建API
   - 支持多种边框样式和对齐方式
   - 处理表格宽度和列宽调整

3. **终端适配**
   - 检测终端功能支持（如颜色、宽度）
   - 实现智能断行和对齐
   - 处理Unicode和ASCII之间的兼容性

4. **内容渲染流程**
   1. 准备字符串缓冲区
   2. 渲染标题和元信息
   3. 渲染摘要统计信息
   4. 为每种磁盘类型创建独立表格
   5. 渲染控制器信息表格
   6. 处理增量数据表格
   7. 将完整输出写入文件或标准输出

5. **格式增强**
   - 使用符号指示状态（✓, ⚠, ✕）
   - 实现简单图形（如ASCII艺术图表）
   - 使用空格和分隔符确保良好布局

## 6. 非功能需求

### 6.1 性能需求

1. **内存使用**
   - 优化内存使用，避免大量中间数据结构
   - 支持处理包含数百个磁盘的大型系统
   - PDF生成过程中使用流式处理减少内存需求

2. **响应时间**
   - 文本格式化应在500ms内完成
   - PDF生成应在2秒内完成（标准系统规模）
   - 对大型系统（>100个磁盘），PDF生成不应超过5秒

### 6.2 兼容性需求

1. **输出兼容性**
   - PDF输出应兼容PDF 1.7标准，确保在常见PDF阅读器中正确显示
   - 文本输出应使用UTF-8编码，确保特殊字符正确显示
   - 终端颜色应检测支持并默认回退到无颜色模式

2. **环境兼容性**
   - 支持Linux、FreeBSD和Windows环境
   - 考虑终端类型（xterm、vt100等）的差异
   - 确保不依赖特定系统库

### 6.3 可扩展性需求

1. **新格式支持**
   - 设计允许轻松添加新输出格式（如HTML、JSON）
   - 使用接口和工厂模式确保扩展性

2. **自定义选项**
   - 提供丰富的配置选项以适应不同环境
   - 允许通过配置文件或命令行参数进行控制

## 7. 实现计划

### 7.1 开发阶段

1. **基础结构（2天）**
   - 定义接口和数据结构
   - 实现格式化器工厂
   - 创建基本测试框架

2. **文本格式化器（3天）**
   - 实现核心表格功能
   - 添加ANSI颜色支持
   - 处理宽度自适应和对齐
   - 完善所有磁盘类型的表格定义

3. **PDF格式化器（4天）**
   - 实现基本PDF生成功能
   - 开发表格样式和布局
   - 添加封面和目录功能
   - 实现视觉增强（颜色、图标）

4. **集成与测试（3天）**
   - 与数据收集层集成
   - 进行端到端测试
   - 性能测试和优化
   - 处理边缘情况和错误处理

### 7.2 测试计划

1. **单元测试**
   - 测试输出格式化接口各方法的功能
   - 验证不同配置选项的效果
   - 测试边缘情况（空数据、极限值）

2. **集成测试**
   - 使用真实世界数据集进行验证
   - 验证与磁盘收集模块的交互
   - 检查增量数据计算与显示是否正确

3. **视觉验证**
   - 手动检查生成的PDF和文本输出
   - 确保布局一致性和正确性
   - 验证在不同环境中的显示效果

## 8. 未来扩展

1. **额外输出格式**
   - HTML输出（带交互式表格和图表）
   - JSON/XML输出（用于API集成）
   - CSV输出（用于数据分析）

2. **可视化增强**
   - 在PDF中添加交互式图表
   - 添加磁盘健康趋势分析图表
   - 实现容量使用图形表示

3. **高级功能**
   - 自定义报告模板
   - 报告自动发送（电子邮件、消息系统）
   - 多语言支持

## 9. 风险与缓解

1. **PDF库限制**
   - **风险**: unipdf库可能在处理复杂表格时有性能问题
   - **缓解**: 考虑替代库（如gofpdf）或实现表格分页逻辑

2. **终端兼容性**
   - **风险**: 不同终端对ANSI颜色和Unicode字符的支持差异
   - **缓解**: 实现自动检测和降级策略，提供无颜色模式选项

3. **性能瓶颈**
   - **风险**: 大型系统可能导致PDF生成缓慢
   - **缓解**: 实现流式处理，考虑分页生成策略

## 10. 成功标准

1. **功能完整性**
   - 成功实现所有规定的输出格式和功能
   - 正确显示所有类型的磁盘和控制器信息

2. **性能达标**
   - 满足规定的响应时间要求
   - 成功处理大型系统（>100个磁盘）

3. **用户体验**
   - 提供清晰、专业的输出格式
   - 输出内容易于理解和分析
   - 视觉元素有效传达系统状态

## 11. 附录：输出示例

### 11.1 PDF输出示例

[示意图：包含封面、磁盘表格、控制器信息和历史数据的PDF报告页面]

### 11.2 文本输出示例

```
=== TrueNAS磁盘健康监控 (2025-03-10 12:34:56) ===

系统摘要:
- 总磁盘数: 8 (SSD: 4, HDD: 4)
- 警告数: 1
- 错误数: 0

--- SAS/SATA 固态硬盘 ---
+------+--------------------+-------+--------+------+---------------+--------+---------+
| 名称 | 型号               | 容量  | 存储池 | 温度 | 通电时间      | 状态   | 已用寿命|
+------+--------------------+-------+--------+------+---------------+--------+---------+
| sda  | Samsung SSD 870    | 1 TB  | tank   | 32°C | 1y 3m 5d      | PASSED | 12%     |
| sdb  | Samsung SSD 870    | 1 TB  | tank   | 35°C | 1y 3m 5d      | PASSED | 15%     |
+------+--------------------+-------+--------+------+---------------+--------+---------+

[其他表格内容...]
```